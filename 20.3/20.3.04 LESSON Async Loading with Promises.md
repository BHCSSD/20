# 20.3.04 LESSON Async Loading with Promises
```
20.3.04 LESSON Async Loading with Promises
```

**Things to focus on:**

1. Why loading images can take time and block the sketch.
2. How JavaScript runs image loading in the **background** using Promises.
3. How to display images **only after they’ve finished loading**.
4. How to handle errors gracefully when a file fails to load.

[Watch this video for extra help](https://youtu.be/25omXt_OjD4?si=A-NCkBgvVZVz39MZ)
---

## Part 1: Old School `preload()`

* In early versions of p5.js, you used `preload()` to load images.
  * This function **stopped the entire program** until every asset was finished loading.
  * Problem: the page freezes, nothing draws, no interaction is possible until all images finish.
* Modern p5.js encourages **asynchronous loading** using Promises, so your sketch can keep running and remain responsive.

> [!NOTE]
> ## INFODUMP:
>
> JavaScript runs on a **single thread**, meaning it can only do one main task at a time.
> If you try to load big files directly, your program **stops and waits**.
>
> * Async loading changes this: it runs the loading task **in the background**, letting your `draw()` loop keep updating the canvas while the browser fetches images.

---

## Part 2: Theory: How p5.js Loads Images

When you write:

```js
let img;

function preload() {
  img = loadImage("cat.png");
}
````

p5.js handles the loading behind the scenes with Promise-like behavior:

| Stage         | Promise State | What’s Happening                                 | Result       |
| ------------- | ------------- | ------------------------------------------------ | ------------ |
| **Pending**   | `pending`     | The image is downloading.                        | `undefined`  |
| **Fulfilled** | `fulfilled`   | The image finished loading.                      | Image object |
| **Rejected**  | `rejected`    | The image couldn’t load (e.g., wrong file path). | Error object |

#### How p5.js Uses Promises for You

* `loadImage()` starts loading the image in the **background** (Promise **pending**).
* If it loads successfully, the Promise is **fulfilled**, and your variable now holds the image.
* If it fails, the Promise is **rejected**, and the console shows an error.
* `preload()` pauses the rest of the sketch until all assets are ready.

---

## Part 3: Example: Custom Image Loader, Async

You can create your own Promise-based loader.... if you wanted to be too extra:

```js
function loadImagePromise(path) {
  // Return a new Promise to handle image loading asynchronously
  return new Promise((resolve, reject) => {
    
    // Create a new blank Image object
    let img = new Image();
    
    // Runs if the image loads successfully
    img.onload = () => resolve(img);
    
    // Runs if there is an error loading the image
    img.onerror = () => reject("Failed to load: " + path);
    
    // Start downloading the image in the background
    img.src = path;
  });
}
```


---

## Part 4: TODO: Making Our Own Async Function
> This is how I need you to load files including images and later JSON files.
We can use `async/await` to simplify the code:

Make a new file in p5js. 
```js
let img;


async function loadStuff() {
  img = await loadImage('images/bart.png'); // waits until image is loaded

}

function setup() {
  createCanvas(400, 400);
  loadStuff(); // start loading in background
}
```

**Why this works:**

* `loadStuff()` runs without stopping `setup()` or `draw()`.
* `await` pauses **inside `loadStuff()` only**, not the entire program.
* While waiting, the browser can continue other tasks (like drawing frames or handling input).
* Once the image is ready, `await` returns the image and stores it in `img`.
* Setting `loaded = true` signals that the image can now be drawn.

---

## Part 5: Drawing the Image in `draw()`

```js
function draw() {
  background(220);

  /*
  Super lazy moment: 
  if(img) is the same as if(img == true)
  because the an empty img is false, and a full img is ture
  */

  if (img) {
    image(img, 0, 0, 400, 400); // Draw only after it's ready
  } else {
    text("Loading image...", 20, 200);
  }
}
```

**Why this works:**

* `draw()` runs ~60 times per second no matter what.
* At first, `loaded` is `false`, so we show “Loading image…”.
* Once `loadStuff()` finishes, `loaded` becomes `true`.
* From that frame onward, the image is displayed.

---

## Part 6: How the Background Process Works

1. `loadImage()` sends a **request** to the browser.
2. The download happens **in parallel**, outside the main JS thread.
3. When done, the browser calls your success callback (`resolve`).
4. The Promise “resolves,” and your code resumes after `await` or inside `.then()`.
5. If something goes wrong (like a 404 error), the Promise **rejects** and triggers `.catch()`.

> [!TIP]
> **Analogy:**
>
> 1. You order pizza online (`loadImage()`),
> 2. keep playing your game (`draw()` keeps running),
> 3. only when the pizza arrives (Promise resolves) do you eat it (draw the image).

---

## Part 7: Summary Table

| Concept           | How it Works                                                                 |
| ----------------- | ---------------------------------------------------------------------------- |
| **Promise**       | A placeholder for a value that will arrive later.                            |
| **resolve()**     | Called when the image successfully loads.                                    |
| **reject()**      | Called if the image fails to load.                                           |
| **.then()**       | Runs after the Promise finishes.                                             |
| **.catch()**      | Runs if the Promise fails (useful for debugging or fallback images).         |
| **Async Loading** | Lets your sketch run normally while assets load in the background.           |
| **await**         | Pauses inside one async function until the Promise finishes, then continues. |

---

## TL;DR What’s Really Happening

1. You **request** the image, but don’t get it immediately.
2. The browser downloads it **in the background**.
3. JavaScript keeps running your sketch; `draw()` doesn’t stop.
4. When the image is ready, the Promise resolves and your code updates to show it.


